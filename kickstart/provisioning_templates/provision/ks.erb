<%#
kind: provision
name: GatwardIT-ks
oses:
- Red Hat Enterprise Linux 7
- CentOS 7
%>
<%
  rhel_compatible = @host.operatingsystem.family == 'Redhat' && @host.operatingsystem.name != 'Fedora'
  os_major = @host.operatingsystem.major.to_i
  # safemode renderer does not support unary negation
  pm_set = @host.puppetmaster.empty? ? false : true
  puppet_enabled = pm_set || host_param('force-puppet')
  section_end = (rhel_compatible && os_major <= 5) ? '' : '%end'
%>
install
<%= @mediapath %>
lang en_US.UTF-8
selinux --enforcing
keyboard us
skipx

<% subnet = @host.subnet -%>
<% if subnet.respond_to?(:dhcp_boot_mode?) -%>
<% dhcp = subnet.dhcp_boot_mode? && !@static -%>
<% else -%>
<% dhcp = !@static -%>
<% end -%>

network --bootproto <%= dhcp ? 'dhcp' : "static --ip=#{@host.ip} --netmask=#{subnet.mask} --gateway=#{subnet.gateway} --nameserver=#{[subnet.dns_primary, subnet.dns_secondary].select{ |item| item.present? }.join(',')}" %> --hostname <%= @host %><%= os_major >= 6 ? " --device=#{@host.mac}" : '' -%>

rootpw --iscrypted <%= root_pass %>
firewall --<%= os_major >= 6 ? 'service=' : '' %>ssh
authconfig --useshadow --passalgo=sha512 --kickstart
timezone --utc <%= host_param('time-zone') || 'Australia/Sydney' %>

bootloader --location=mbr --append="nofb quiet splash=quiet" <%= grub_pass %>

<%# Include the dynamic disk config if it is defined -%>
<% if @dynamic -%>
%include /tmp/diskpart.cfg
<% else -%>
<%= @host.diskLayout %>
<% end -%>

text
reboot

%packages --ignoremissing
@Core
aide
bind-utils
chrony
dhclient
dos2unix
mlocate
policycoreutils-python
policycoreutils-restorecond
screen
vim
wget
yum
yum-utils
-iwl*
-ivtv*
<%= section_end -%>

<%# Generate dynamic partition table configuration -%>
<% if @dynamic -%>
%pre
<%= @host.diskLayout %>
<%= section_end -%>
<% end -%>

%post --nochroot
exec < /dev/tty3 > /dev/tty3
#changing to VT 3 so that we can see whats going on....
/usr/bin/chvt 3
(
cp -va /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
/usr/bin/chvt 1
) 2>&1 | tee /mnt/sysimage/root/install.postnochroot.log
<%= section_end -%>


%post
logger "Starting anaconda <%= @host %> postinstall"
exec < /dev/tty3 > /dev/tty3
#changing to VT 3 so that we can see whats going on....
/usr/bin/chvt 3
(
<% if subnet.respond_to?(:dhcp_boot_mode?) -%>
  <%= snippet 'kickstart_networking_setup' %>
<% end -%>

### Network tweaks

<% if @host.operatingsystem.name == "RedHat" %>
  <%= snippet "GatwardIT-snippet_satellite_registration" %>
<% else -%>
  <%= snippet "GatwardIT-snippet_centos_repos" %>
<% end -%>

### Enable any custom repos

<%# update local time %>
echo "++++++++++++++++++++++++++++ Setting System Time ++++++++++++++++++++++++++++++"
echo ">>> Updating system time & setting BIOS clock"
yum -q -y install ntpdate
ntpdate -sub <%= host_param('ntp-server') || 'ntp1.core.home.gatwards.org ntp2.core.home.gatwards.org' %>
hwclock --systohc

<%# Fix NTP sources %>
sed -i 's/^server 0.*/server ntp1.core.home.gatwards.org iburst/' /etc/chrony.conf
sed -i 's/^server 1.*/server ntp2.core.home.gatwards.org iburst/' /etc/chrony.conf
sed -i 's/^server 2.*/server ntp3.core.home.gatwards.org iburst/' /etc/chrony.conf
sed -i '/^server 3.*/d' /etc/chrony.conf

<%# Generate stronger host SSH keys %>
<%= snippet "GatwardIT-snippet_generate_hardened_sshkeys" %>

<%# Apply SSH hardening -%>
<%# We do this early in the KS as it will get modified by the IPA installer (if we are using it) %>
echo "+++++++++++++++++++++++++ Initial SSH hardening +++++++++++++++++++++++++++++++"
cat << EOF > /etc/ssh/ssh_config
<%= snippet "GatwardIT-config_ssh_config" %>
EOF
cat << EOF > /etc/ssh/sshd_config
<%= snippet "GatwardIT-config_sshd_config" %>
EOF
# Just in case...
dos2unix /etc/ssh/ssh_config
dos2unix /etc/ssh/sshd_config

<%# Update all the installed base packages from the updates repo %>
echo "++++++++++++++++++++++++++++ Update all packages ++++++++++++++++++++++++++++++"
echo ">>> Updating packages..."
yum -y update
<%# Updating centos-release will restore the default CentOS repo configs and break things from here %>
<% if @host.operatingsystem.name == "CentOS" -%>
  rm -f /etc/yum.repos.d/CentOS*
<% end -%>

<%# Check if we are a VMware guest - if so then install the tools %>
if [ "$(virt-what)" == "vmware" ]; then
  echo "+++++++++++++++++++++++ VM Guest Agent Configuration ++++++++++++++++++++++++++"
  echo ">>> Installing VMware tools..."
  yum -q -y install open-vm-tools
  systemctl enable vmtoolsd
elif [ "$(virt-what)" == "rhev" ]; then
  echo "+++++++++++++++++++++++ VM Guest Agent Configuration ++++++++++++++++++++++++++"
  echo ">>> Installing ovirt guest agent..."
  yum -q -y install ovirt-guest-agent
  systemctl enable ovirt-guest-agent
fi

<%# If we are part of an IdM realm, enrol here -%>
<% if @host.respond_to?(:realm) && @host.otp && @host.realm && @host.realm.realm_type == "Red Hat Identity Management" -%>
  <%= snippet "GatwardIT-snippet_idm_register" %>
<% end -%>

<%# If we are part of an AD domain, enrol here -%>
<% if host_param('ad') -%>
  <%= snippet "GatwardIT-snippet_AD" %>
<% end -%>

<%# If we are part of an LDAP environment, bind to LDAP here -%>
<% if host_param('ldap') -%>
  <%= snippet "GatwardIT-snippet_LDAP" %>
<% end -%>

<%# Configure either local or autofs home directories (IdM snippet handles this if IPA is used) %>
<% if host_param('ad') || host_param('ldap') -%>
  <%= snippet "GatwardIT-snippet_homedirs" %>
<% end %>

<%# Install root CA certs %>
<%= snippet "GatwardIT-snippet_trust_certs" %>

<%# Configure misc tooling %>
<%= snippet "GatwardIT-snippet_misc" %>

<%# If 'auto_update' host parameter is defined, configure yum-cron %>
<% if host_param_true?('auto_update') -%>
  <%= snippet "GatwardIT-snippet_autoupdate" %>
<% end -%>

<%# If the 'server_gui' host parameter is defined, install the GUI components %>
<% if host_param_true?('server_gui') -%>
  <%= snippet "GatwardIT-snippet_gui" %>
<% end -%>

<%# If the 'nessus_agent' host parameter is defined, install the Nessus Scanner Agent %>
<% if host_param('nessus_agent') -%>
  <%= snippet "GatwardIT-snippet_nessus" %>
<% end -%>

<%# Apply initial static ISM hardening - can be overridden if needed %>
<%= snippet "GatwardIT-snippet_ISM" %>

<%# In some situations our hostname is not being set. Force it here in case %>
echo "<%= @host %>" > /etc/hostname

<% if puppet_enabled %>
  echo "+++++++++++++++++++++++++ Puppet configuration ++++++++++++++++++++++++++++++"
  echo ">>> Installing puppet packages..."
  yum -q -y install puppet

  echo ">>> Configuring puppet"
  cat > /etc/puppet/puppet.conf << EOL
<%= snippet 'puppet.conf' %>
EOL

  # Setup puppet to run on system reboot
  systemctl enable puppet
  /usr/bin/puppet agent --config /etc/puppet/puppet.conf -o --tags no_such_tag <%= @host.puppetmaster.blank? ? '' : "--server #{@host.puppetmaster}" %> --no-daemonize
<% end -%>


<%# If we have updated any kernel params during hardening, we need to rebuild the grub config %>
echo "+++++++++++++++++++++++++++ Kernel configuration ++++++++++++++++++++++++++++++"
echo ">>> Rebuilding grub2 config..."
grub2-mkconfig -o /boot/grub2/grub.cfg

<%# After disabling kernel modules during hardening, a new initramfs needs to be created %>
echo ">>> Rebuilding initramfs..."
KERNEL_VERSION=$(rpm -q kernel --qf '%{version}-%{release}.%{arch}\n' | tail -n 1)
echo $KERNEL_VERSION
dracut -f /boot/initramfs-$KERNEL_VERSION.img $KERNEL_VERSION

sync

<% if @provisioning_type == nil || @provisioning_type == 'host' -%>
  # Inform the build system that we are done.
  echo ">>> Informing Satellite that we are built"
  wget -q -O /dev/null --no-check-certificate <%= foreman_url('built') %>
<% end -%>
) 2>&1 | tee /root/install.post.log
exit 0

<%= section_end -%>
