<%#
kind: snippet
name: GatwardIT-snippet_satellite_registration
%>
echo "++++++++++++++++++ Red Hat Satellite registration Snippet +++++++++++++++++++++++++++++++++++"

<%# Subscription manager registration snippet, customized for environment -%>
<% if host_param('kt_activation_keys') %>

  echo ">>> Install Satellite Certificates"
  rpm -ivh <%= subscription_manager_configuration_url(@host) %>

  echo ">>> Adding custom Satellite facts"
  echo "{\"satellite.capsule\":\"$(grep baseurl /etc/rhsm/rhsm.conf | cut -f3 -d/)\"}" > /etc/rhsm/facts/satellite.facts

  <%# Increase subscription-manager client timeout %>
  subscription-manager config --server.server_timeout 180

  echo ">>> Registering the system to Satellite"
  sleep $((RANDOM % 15))
  subscription-manager register --org="<%= @host.rhsm_organization_label %>" --name="<%= @host.name %>" --activationkey="<%= host_param('kt_activation_keys') %>"

  <%# Auto attach for VDC subscriptions %> 
  sleep 5
  subscription-manager attach --auto

  echo ">>> Enable additional RHEL repositories"
  subscription-manager repos --enable=rhel-*-satellite-tools-6.3-rpms
  subscription-manager repos --enable=rhel-*-server-optional-rpms

  echo ">>> Installing Katello Agent Tools"
  yum -q -y install katello-host-tools
<% end %>
