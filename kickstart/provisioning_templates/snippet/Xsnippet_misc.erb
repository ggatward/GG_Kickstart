<%#
kind: snippet
name: GatwardIT-Xsnippet_misc
model: ProvisioningTemplate
snippet: true
%>

<%
rhel_compatible = @host.operatingsystem.family == 'Redhat' && @host.operatingsystem.name != 'Fedora'
is_fedora = @host.operatingsystem.name == 'Fedora'
os_major = @host.operatingsystem.major.to_i
os_minor = @host.operatingsystem.minor.to_i
%>

echo "+++++++++++++++++ Misc Tools and Configuration Snippet ++++++++++++++++++++++++"

echo ">>> Installing filesystem support packages..."
yum -q -y install autofs nfs-utils samba-client samba-common cifs-utils

echo ">>> Configuring network mount points"
mkdir -p /data/{dir1,dir2,dir3}

<%# Create mount script %>
cat << EOF > /usr/local/bin/mounts.sh
sudo /bin/mount -t cifs -o user=\$USER,cruid=\$USER,uid=\$USER,sec=krb5 //nas1.core.home.gatwards.org/volume1/\$USER
EOF



echo ">>> Installing other common tools"
yum -q -y install git tree iotop vim iptraf dstat dropwatch bash-completion
if [ $(yum repolist | grep -ic epel) -ne 0 ]; then
  yum -q -y install bash-completion-extras htop iptstate
fi



echo ">>> Configure mail relay"
sed -i 's/#relayhost = $mydomain/relayhost = mailhost.core.home.gatwards.org/' /etc/postfix/main.cf



echo ">>> Removing rhgb kernel option"
<% if (is_fedora && os_major >= 16) || (rhel_compatible && os_major >= 7) -%>
sed -i '/GRUB_CMDLINE_LINUX.*$/{s/ rhgb//}' /etc/default/grub
<% else -%>
sed -i 's/ rhgb//' /etc/grub.conf
<% end -%>


echo ">>> Configuring root prompt"
if [ $(hostname -f | grep -c '.qa.') -eq 1 ]; then
  echo 'export PS1="\[\033[0;36m\]\u@\h.qa\[\033[0;36m\][\w] #\[\033[0m\] "' >> /root/.bashrc
elif [ $(hostname -f | grep -c '.lab.') -eq 1 ]; then
  echo 'export PS1="\[\033[0;33m\]\u@\h.lab\[\033[0;33m\][\w] #\[\033[0m\] "' >> /root/.bashrc
else
  echo 'export PS1="\[\033[0;31m\]\u@\h\[\033[0;32m\][\w] #\[\033[0m\] "' >> /root/.bashrc
fi
