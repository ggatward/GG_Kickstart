<%#
kind: snippet
name: GatwardIT-Xsnippet_autoupdate
model: ProvisioningTemplate
snippet: true
%>
echo "++++++++++++++++++++++++++ Autoupdate Snippet +++++++++++++++++++++++++++++"

# Install required packages
echo ">>> Installing packages..."
yum -q -y install yum-cron
systemctl enable yum-cron

# Configure update policy
sed -i 's/update_messages = no/update_messages = yes/g' /etc/yum/yum-cron.conf
sed -i 's/download_updates = no/download_updates = yes/g' /etc/yum/yum-cron.conf
sed -i 's/apply_updates = no/apply_updates = yes/g' /etc/yum/yum-cron.conf
sed -i 's/random_sleep = 360/random_sleep = 60/g' /etc/yum/yum-cron.conf

sed -i 's/update_messages = no/update_messages = yes/g' /etc/yum/yum-cron-hourly.conf
sed -i 's/download_updates = no/download_updates = yes/g' /etc/yum/yum-cron-hourly.conf
sed -i 's/apply_updates = no/apply_updates = yes/g' /etc/yum/yum-cron-hourly.conf
rm -rf /etc/cron.hourly/0yum-hourly.cron

# Configure yum to only keep the last 3 revisions
sed -i '/bugtracker_url=/d' /etc/yum.conf
sed -i 's/installonly_limit=.*/installonly_limit=2/g' /etc/yum.conf

# Disable fastest mirror plugin
if [ -f /etc/yum/pluginconf.d/fastestmirror.conf ]; then
  sed -i 's/enabled=1/enabled=0/g' /etc/yum/pluginconf.d/fastestmirror.conf
fi
