<%#
kind: snippet
name: GatwardIT-snippet_idm_register
%>
echo "+++++++++++++++++++++ IPA Client configuration Snippet ++++++++++++++++++++"

# Optional parameters:
#   idm_server              IdM server
#
#   idm_automount_location  Location for automounts
#
#   idm_opts                Additional options to pass directly to installer
#

<%# Generate new host ssh keys %>
/usr/sbin/sshd-keygen

echo ">>> Install IPA packages"
yum -q -y install libsss_sudo ipa-client

## IDM Client Installation
<% domain = host_param('idm_domain') || @host.realm.name.downcase -%>

<% if host_param('idm_server') -%>
  idm_server="--server <%= host_param('idm_server') %>"
<% end -%>

<% if host_param_true?('localhomedirs') -%>
  idm_mkhomedir="--mkhomedir"
<% end -%>

<% if host_param('idm_opts') -%>
  idm_opts="<%= host_param('idm_opts') %>"
<% end -%>

echo ">>> Enroling with IPA server"
<%# One-time password will be requested at install time. Otherwise, $HOST[OTP] is used as a placeholder value. %>
/usr/sbin/ipa-client-install -w '<%= @host.otp || "$HOST[OTP]" %>' --realm=<%= @host.realm %> --domain=<%=domain %> -U $idm_mkhomedir $idm_opts $idm_server

### DEVILHORN IMPLEMENTATION
# Additional host parms:
# - dh_svcprincipal
# - dh_svcprincipal_pass (hidden)
# - ipa_host_groups
#
# kinit using service principal
#echo <%#= host_param('dh_svcprincipal_pass') %> | /usr/bin/kinit <%#= host_param('dh_svcprincipal') %>
#
# Loop through each hostgroup and add host to them
#<%# for pool in host_param('ipa_host_groups').split(',') %>
#  /usr/bin/ipa hostgroup-add-member <%# pool %> --hosts `hostname -f`
#<%# end %>
#
### END DEVILHORN


<%# Add domain options for realm trust %>
cat << EOF > /etc/sssd/conf.d/ad.conf
[sssd]
default_domain_suffix = AD.HOME.GATWARDS.ORG
full_name_format = %1\$s
EOF
chmod 600 /etc/sssd/conf.d/ad.conf


## Automounter
<% if host_param_false?('localhomedirs') -%>
  echo ">>> Configuring IPA NFS automounts"
  /usr/sbin/ipa-client-automount $idm_server <%= host_param('idm_automount_location') %> --unattended

  # Enable use_nfs_homedirs boolean
  /usr/sbin/setsebool -P use_nfs_home_dirs 1

  <%# Workaround for BZ 1392540 - force 'autofs: files sss' in /etc/nsswitch.conf %>
  authconfig --updateall
<% end -%>
