<%#
kind: snippet
name: GatwardIT-snippet_ansible_provisioning_callback
-%>
echo "+++++++++++++++++++++ Ansible Callback configuration ++++++++++++++++++++++++++"

<%# Create one-shot service to run on first boot to do the callback %>
echo ">>> Creating Ansible Callback Service"
cat << EOF > /etc/systemd/system/ansible-callback.service
[Unit]
Description=Provisioning callback to Ansible Tower
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/bin/curl -k -s --data "host_config_key=<%= host_param('ansible_host_config_key') -%>" https://<%= host_param('ansible_tower_fqdn') -%>/api/v2/job_templates/<%= host_param('ansible_job_template_id') -%>/callback/
ExecStartPost=/usr/bin/systemctl disable ansible-callback

[Install]
WantedBy=multi-user.target
EOF

<%# Enable the ansible-callback one-shot service %>
systemctl enable ansible-callback
